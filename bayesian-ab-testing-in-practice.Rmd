---
layout: page
title: 데이터 과학 -- 기초 통계
subtitle: 베이지안 A/B 검정
output:
  html_document: 
    keep_md: yes
    toc: yes
  pdf_document:
    latex_engine: xelatex
mainfont: NanumGothic
---

``` {r, include=FALSE}
source("tools/chunk-options.R")
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)

library(tidyverse)
library(ggplot2) 
library(ggthemes)
library(pwr)
library(extrafont)
library(prevalence) # https://gist.github.com/casallas/8411082
loadfonts()

options(scipen = 999)
options(dplyr.width = 120)
options(dplyr.print_max = 1e9)
```

<img src="fig/ab-testing-campaigns.png" alt="A/B 검정을 위한 마케팅 홍보안" width="77%" />

## 1. 마케팅 캠페인 사례 [^bayesian-part-one] [^bayesian-part-two] [^bayesian-part-three]

[^bayesian-part-one]: [Video Introduction to Bayesian Data Analysis, Part 1: What is Bayes?](http://www.sumsar.net/blog/2017/02/introduction-to-bayesian-data-analysis-part-one/)
[^bayesian-part-two]: [Video Introduction to Bayesian Data Analysis, Part 2: Why use Bayes?](http://www.sumsar.net/blog/2017/02/introduction-to-bayesian-data-analysis-part-two/)
[^bayesian-part-three]: [Video Introduction to Bayesian Data Analysis, Part 3: How to do Bayes?](http://www.sumsar.net/blog/2017/05/introduction-to-bayesian-data-analysis-part-three/)

속초에 소재한 건어물 식품회사는 서울에서 활로를 모색하고자, 신제품 오징어 건어물 신제품을 만들어서 마케팅 기획안을 만들었다.
마케팅 캠페인에 대한 다양한 질문에는 다음이 포함된다.

- 새로운 마케팅 홍보안을 시장에 출시할 경우 구매율은 얼마나 될까?
- 전문가의 경험을 반영할 경우 구매율의 95% 신뢰구간을 변화가 있나?
- A안과 비교하여 새로운 B 홍보안은 반응률에 차이가 있을까?
- 투입되는 비용과 매출을 고려한 순이익관점에 봤을 때 앞선 의사결정이 뒤바뀌게 되는가?


### 1.1. 베이지안 추론 [^rasmus-baeysian]

[^rasmus-baeysian]: [Video Introduction to Bayesian Data Analysis, Part 1: What is Bayes?](http://www.sumsar.net/blog/2017/02/introduction-to-bayesian-data-analysis-part-one/)

먼저, **베이즈 추론(Bayesian inference)**은 통계적 추론의 한 방법으로, 
추론해야 하는 대상의 사전 확률과 추가적인 관측을 통해 획득한 데이터를 기반으로 해당 대상의 사후 확률을 추론하는 방법이다. 
사전분포, 데이터, 생성모형, 모수 모두 긴밀히 연결되어 있다. 
베이지안 자료분석은 데이터와 생성모형을 알고 있을 때 베이즈 추론을 통해 모수를 찾아낸다.
반대로 모수와 생성모형을 알고 있다면 데이터를 생성시킬 수 있다.

- 사전분포(Prior)
- 모수(Parameter)
- 생성 모형(Generative Model)
- 데이터(Data)

사전분포를 제외하고 모수, 재생모형, 데이터의 관계를 보면, 모수를 알고, 재생모형을 알고 있다면 데이터를 생성시킬 수 있다.
반대로 데이터와 재생모형을 알고 있거나 재생모형을 가정하게 되면 모수를 추정할 수 있다.
베이즈 추론은 데이터를 갖고 재생모형을 통해 모수를 추론하는 방법론으로 일반화 선형회귀모형, 군집분석모형 등과 이러한 면에서 차이가 난다.

<img src="fig/bayesian_inference_concept.png" alt="베이즈 추론" width="77%" />

### 1.2. 베이즈 정리 및 추론 수식

베이즈 정리를 사용하면 $P(A|B)$ 가 주어졌을 때 $P(B|A)$ 확률을 계산할 수 있기 때문에 유용하다.

$P(A,B) = P(B|A) \times P(A)\\
P(A,B) = P(A|B) \times P(B)$

따라서, 

$$P(B|A) = \frac{P(A,B)}{P(A)} = \frac{P(A|B) \times P(B)}{P(A)}$$

근사 베이즈 계산(ABC, Approximate Bayesian Computation)을 위해서 데이터가 주어졌을 때 
모수를 찾아내는 것으로 다음과 같이 정리하게 된다.

$$P(\Theta|D) = \frac{P(\Theta)P(D|\Theta)} {\Sigma P(\Theta)P(D|\Theta)}$$

즉, A안과 B안의 마케팅 홍보안이 있을 때 A안이 B안보다 더 좋은 성과를 낼 확률을 다음과 같이 정의할 수 있다.
A가 B보다 나을 확률은 [Miller 해법](http://www.evanmiller.org/bayesian-ab-testing.html#binary_ab_derivation)에 따라 다음과 같이 계산할 수 있다.

$$p_A \sim \mbox{Beta}(\alpha_A, \beta_A)$$

$$p_B \sim \mbox{Beta}(\alpha_B, \beta_B)$$

$${\rm Pr}(p_B > p_A) = \sum_{i=0}^{\alpha_B-1}\frac{B(\alpha_A+i,\beta_A+\beta_B)}{(\beta_B+i) B(1+i, \beta_B) B(\alpha_A, \beta_A) }$$

여기서 $$B$$는 베타함수가 된다. 
A/B 검정에서 많이 사용되는 베이지안 사전분포는 베타분포고, 응답율을 이항분포를 가정할 경우, 사후분포는 베타분포가 되고 모수는 다음과 같다. 

$$ ~ Beta (\alpha + s, \beta + n - s)$$

- $\alpha:$ 베타분포 첫번째 모수
- $\beta:$ 베타분포 두번째 모수
- $n:$ 시행 횟수
- $s:$ 성공 횟수

이를 R 코드로 구현한 것은 다음과 같다. [^varianceexplained-ab-testing]

[^varianceexplained-ab-testing]: [Understanding Bayesian A/B testing (using baseball statistics)](http://varianceexplained.org/r/bayesian_ab_baseball/)

``` {r miller-ab-testing-r}
h <- function(alpha_a, beta_a,
              alpha_b, beta_b) {
  j <- seq.int(0, round(alpha_b) - 1)
  log_vals <- (lbeta(alpha_a + j, beta_a + beta_b) - log(beta_b + j) -
               lbeta(1 + j, beta_b) - lbeta(alpha_a, beta_a))
  1 - sum(exp(log_vals))
}
```

<img src="fig/ab-testing-bayesian-mechanics.png" alt="베이지안 처리절차" width="37%" />

## 2. 마케팅 홍보 A안의 구매율 효과는 얼마나 될까?


가장 먼저 홍보를 전혀 하지 않는 것과 비교하여 건어물을 홍보하는 책자를 제작하여 발송하는 경우, 
실제구매율이 얼마나 되는지 파악하고자 한다. 
서울소재한 16가구에 배송하여 6명이 제품구매를 결정했다. 이 데이터를 바탕으로 
실제 구매율은 얼마나 될지 평균 구매율과 95%신뢰구간을 구해보자.

### 2.1. 순수 R 코드로 구현한 구매율

균등분포를 사전분포로 가정하고, 
재생모형(generative model)은 이항분포를 16회를 실행횟수로 놓고 모수에서 난수를 뽑는다.
`n_draws` 횟수만큼 반복하고, 데이터 성공횟수 **6**을 맞춘 사후분포만 추린다.

``` {r simple-bayesian}
## 1.1. 사전분포 정의
n_draws <- 10000

prior <- runif(n_draws, min=0, max=1)

## 1.2. 재생모형(generative model) 
generative_model <- function(parameters) {
  subscribers <- rbinom(1, 16, parameters)
  return(subscribers)
}

## 1.3. 모수 사후분포
# 사전분포와 재생모형을 통해 모의 데이터 생성
sim_data <- rep(NA, n_draws)
for(i in 1:n_draws) {
  sim_data[i] <- generative_model(prior[i])
}

# 모수 사후분포 
posterior <- prior[sim_data == 6] 
length(posterior) # 충분한 표본이 추출되었는지 검증

## 1.4. 중위수와 신뢰구간(Credible Interval)
par(mfrow=c(2,1))
hist(prior, xlim = c(0, 1), main="사전분포", xlab="구매율")
hist(posterior, xlim = c(0, 1), main="사후분포", xlab="구매율")
abline(v = median(posterior), col = "red", lwd =2)

median(posterior)
quantile(posterior, c(0.025, 0.975))
```

16회 실험하여 6회 성공이 나온 경우 즉, 16명에게 마케팅 홍보하여 6회 구매가 일어난 데이터를 기반으로 
평균 구매율(`r round(median(posterior)*100, 1)` %)과 95% 신뢰구간을 
[`r round(quantile(posterior, c(0.025, 0.975))[[1]]*100, 1)` %, `r round(quantile(posterior, c(0.025, 0.975))[[2]]*100, 1)` %]으로 
추정할 수 있다.

